<!doctype html>
<meta charset="utf-8" />
<title>RAG demo — OTCv8 Docs</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font:14px system-ui,Segoe UI,Roboto,Arial;max-width:900px;margin:32px auto;padding:0 16px}
  .row{display:flex;gap:8px}
  input{flex:1;padding:10px;border:1px solid #ccc;border-radius:8px}
  button{padding:10px 14px;border:0;border-radius:8px;background:#222;color:#fff;cursor:pointer}
  li{margin:12px 0}
  .muted{opacity:.75}
</style>

<h2>RAG search (OTCv8 Docs)</h2>
<div class="row">
  <input id="q" placeholder="np. Lua events / OTUI / Android build" />
  <button id="go">Szukaj</button>
</div>
<p class="muted">Uwaga: pierwszy start może chwilę ładować model (WASM).</p>
<ul id="out"></ul>

<script type="module">
  import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js';

  const EMB_URL = './embeddings.json'; // leży obok tej strony
  const extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');

  const data = await fetch(EMB_URL).then(r => r.json());

  const dot = (a,b)=>a.reduce((s,v,i)=>s+v*b[i],0);
  const norm = a => Math.sqrt(dot(a,a));
  const cos = (a,b)=> dot(a,b)/(norm(a)*norm(b));

  async function search(q,k=5){
    const qv = await extractor(q,{ pooling:'mean', normalize:true });
    const qarr = Array.from(qv.data);
    return data
      .map(d => ({ ...d, score: cos(qarr, d.embedding) }))
      .sort((a,b)=>b.score-a.score)
      .slice(0,k);
  }

  function docUrl(path){
    // zamień ścieżkę MD na stronę MkDocs
    return '../' + path.replace(/^docs\//,'').replace(/\.md$/,'/');
  }

  document.getElementById('go').onclick = async () => {
    const q = document.getElementById('q').value.trim();
    if(!q) return;
    const res = await search(q,5);
    const out = document.getElementById('out');
    out.innerHTML = '';
    for(const r of res){
      const li = document.createElement('li');
      const url = docUrl(r.path);
      li.innerHTML = `<a href="${url}" target="_blank">${url}</a> — score: ${r.score.toFixed(3)}
        <div class="muted">${r.text.slice(0,220).replace(/\s+/g,' ')}…</div>`;
      out.appendChild(li);
    }
  };
</script>
